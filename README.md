PCBModelHelper
===
PCBModelHelper is tool suite in order to help building [Autodesk Fusion 360](https://www.autodesk.com/products/fusion-360/overview) 3D model of PCB designed by [Autodesk Eagle](https://www.autodesk.com/products/eagle/overview).

Eagle can manage 3D model for each device in component library and provides a function to export Fusion 360 3D model from board design.
This fucntion is useful to proceed collaborative work between electrical design and mechanical design.<br>
And Fusion 360 provides photo realistic 3D CG renderer also. This rendering quority is very high enough to use product catolog.

However, in case reding 3D model exported by Eagle, the result is quite dissappoointing finish as below example.<br>
Since PCB board surface structure is expressed only one decal image, it's texture is flat and matte. We cannot feel metallic luster of pads or  unevenness of circuit pattern from that image.
In addition, there are many artifact patterns on the board surface, I don't know the reason why.<br>
And further more, all components on the board are also matt texture, because 3D model managed in Eagle library is imported as STEP formated data. Even if original 3D model made by Fusion 360 includes specific apearance metadata, such as albedo and/or heigt map, all metadata except color will be dropped when translating to STEP format.<br>
As a result, rendered image looks like a clay work.

PCBModelHelper helps to make a 3D model which can be photo real rendered by Fusion 360. That model has a realistic appearance and original components 3d models that has complete appearance data are placed on the board.

Please compare between detail of following two examples after click to expand images

<p align="center">
<img alt="example of Eagle" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/case-eagle.jpg" width=49%>
<img alt="example of PCBModelHelper" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/case-thistool.jpg" width=49%>
</p>

## Installation
This tool suite include an Eagle ULP scripts and a Fusion 360 Add-on. Eagle ULP script can be run by just specify file path. On the other hand, Fusion 360 Add-on is need to register to Fusion 360 itself.<br>

1. **Clone this git repository**<br>
    ``` shell
    $ git clone https://github.com/opiopan/PCBModelHelper
    ```

2. **Register Add-on program to Fusion 360**<br>
    Enter to Fusion360 Design mode, then execute ```Scripts and Add-ins``` command in ```Add-ins``` panel on ```TOOLS``` tab.

    <p align="center">
    <img alt="step2-1 of installation" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/install01.jpg" width=500> 
    </p>

    Move to ```Add-ins``` tab in the ```Script and Add-ins``` Dialog.<br>
    After that, push the plus button beside of ```My Add-ins``` label.

    <p align="center">
    <img alt="step2-2 of installation" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/install02.jpg" width=300>
    </p>

    Folder selecting dialog is shown. Specify ```fusion360-addin``` folder under the root folder of git repository you cloned at step 1.

    <p align="center">
    <img alt="step2-3 of installation" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/install03.jpg" width=500>
    </p>

    New add-in named ```PCBModelHelper``` is added in ```My Add-ins```. Select this new add-in, then confirm that ```Run on Startup``` is checked. After that, Press  ```Run``` button.

    <p align="center">
    <img alt="step2-4 of installation" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/install04.jpg" width=300>
    </p>


## Preparing component model repository
PCBModelHelper imports electric component models in order to place on PCB model. This add-in program requires that all component models are stored in same folder in the same project which PCB board model are stored.<br>
Please place all 3D model refered from your bord design in same folder before start making PCB 3D model according to steps explaind below.

PCBModelHelper finds a component 3D model file corresponding to a eaach device used in your Eagle pcb design by using foot print name in Eagle library.
If names in Fusion repository is deferent from Eagle library, there is two way to inform correct name to PCBModelHelper.<br>
One is editing a place-info file described later. Place-info file is a generated by Eagle ULP script included in PCBModelHelper, that contains location, rotation angle, and footprint name for each deves.<br>
The other one is specifing correspondence between Eagle library footprint name and Fusion 360 model document name as Json dictionary data. If Json file named ```replace.json``` exists in directory ```fusion360-addin/Resources``` under directory that PCBModelHelper is cloned, PCBModelHelper replaces footprint name according to dictionary data.<br>
Following file is a example of Json dictionary for footprint name replacement, dictionary key express footprint name in Eagle library and value exprress model document name of Fusion 360.

```json
{
    "RCL_C0402_HS": "C1005",
    "MOLEX_48037-0001_1": "480370001",
    "RCL_L0402_HS": "L1005",
    "LED1608" : "led1608",
    "RCL_R0402_HS": "R0402",
    "SMT(4.2X3.2)": "SKRPACE010",
    "LQFP32-M": "LQFP32",
    "CC2500-RTY1_CC2500-HS": "CC2500RGPR",
    "CRYSTAL3225-HS": "CRYSTAL3225"
}
```

## How to make a PCB 3D model
Making PCB 3D model using PCBModelHelper is performed as following five steps.

1. Exporting information to generate 3D model from Eagle
2. Creating texture bitmaps for board appearance
3. Generate board body
4. Appling appearance to board body
5. Placing device models on board

Tools provided by PCBModelHelkper is used at step 1, step 4 and step 5.<br>
Step 2 is done by your favorite gerber file imaging tool.<and>
Stope 4 is done by just pure human operation in Fusion 360, but it is not complex.

### 1. Exporting information to generate 3D model from Eagle
Export three kind of data as below from Eagle.

- Fusion 360 model data
- Gerber files
- Place-info file

Since Fusion 360 model and gerber files are generated by starndard function of Eagle, the explanation of detail steps are omitted in this document.

Place-info file is a generated by Eagle ULP script included in PCBModelHelper, that contains location, rotation angle, and footprint name for each deves.<br>
On Eagle board design window, execute ```Run ULP```  command in ```File``` menu

<p align="center">
    <img alt="step 1-1 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make1-1.jpg" width=400>
</p>

Then, press ```Browse``` button at ```ULP``` dialog box in order to specify ULP script provided by PCBModelHelper.<br>
ULP script to run is named ```export-placeinfo.ulp``` in dithrectory ```eagle-ulp``` under directory that PCBModelHelper is cloned.

<p align="center">
    <img alt="step 1-2 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make1-2.jpg" width=700>
</p>

When ```export-placeinfo.ulp``` is executed, an dialog to specify file name and directory to save is shown. Specify place and file name that you want to save.

### 2. Creating texture bitmaps for board appearance
In this section, texture bitmaps using for board apearance.<br>
Following three kind of bitmaps are used for both face, top and bottom. That means you must make six bitmaps.

- **Color map of reagion covered solder mask:**<br>
    Created from gerber file of metal laryer and silk screen layer.

- **Height map that express copper thickness:**<br>
    Created from gerber file of metal layer. <br>
    In order to get better finish of rendering image, I recomend to blur this image a little bit.

- **Cutout map that express region where solder mask does not cover:**<br>
    Created from gerber file of solder mask layer.

<p align="center">
    <img alt="bitmaps for appearance" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/bitmaps.jpg" width=600>
</p>

Any tools which can imaging gerberfile may be suitable to generate these bitmaps.<br>
I use [pcb-tools](https://github.com/curtacircuitos/pcb-tools) for this step. 
[This python script](https://github.com/opiopan/rcstick-f/tree/master/images/3dcg/genimage.py) is a example to generate these bitmaps using pcb-tools. <br>
In my case, gerber file of each layer does not include bord profile (board outline) because I merge multiple gerberfiles to panelize. On the other hand, these texture bitmaps must made aligning with board outline.<br>
Therefore, I translate original gerberfiles by [this script](https://github.com/opiopan/rcstick-f/tree/master/images/3dcg/prepare.py) in advance. This script uses [pcb-tools-extension](http://github.com/opiopan/pcb-tools-extension) in order to merge original gerber file and outline layer.

### 3. Generate board body
From this step, you use Fusion 360. At first, create new document and save with new name.
Then, insert a PCB model generated by Eagle at step 1.

<p align="center">
    <img alt="step 3-1 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-1.jpg" width=400>
</p>

Select top face of board, then create a new body using ```Extrude``` command, and change name to ```base```

<p align="center">
    <img alt="step 3-2 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-2.jpg" width=700>
</p>

Once new board body is created, original PCB model is not necessary. Hyde component of PCB model or delete that.<br>
Next, Set base appearance to this body. This appearance is express via appearance. I usualy apply polished alminum appearance.<br>

<p align="center">
    <img alt="step 3-3 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-3.jpg" width=700>
</p>

And so, Appearance for faces that PCB material is exposed is applied.<br>
As PCB material, I use Wax appearance but color is changed to be yellowish.

<p align="center">
    <img alt="step 3-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-4.jpg" width=700>
</p>

Copy body ```base``` and paste to same coordinate system. Then change name of new body to ```metal```. This body represents metal pad on the boad.

<p align="center">
    <img alt="step 3-5 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-5.jpg" width=700>
</p>

Offset both of top and bottom face of ```metal``` baody on the inside a little, I think 0.01mm is reasonable.<br>
This operation is important to avoid some artifact in final rendering image.

<p align="center">
    <img alt="step 3-6 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make3-6.jpg" width=700>
</p>

### 4. Appling appearance to board body
Execute ```Generate PCB Appearances``` command in ```Modify``` panel.<br>
As a result of execution, following dialog box is shown.

<p align="center">
    <img alt="step 4-1 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make4-1.jpg" width=250>
</p>

Input board width, board height, copper thickness, and sppecify all bitmaps created at step 2.<br>
When you input board width, board height, and copper thickness, you can use ```Measure``` function that specify length by selecting a edge or two points.<br>
If file name of bitmaps are according to following naming convention, you can specify a directory by press ```Select Bunch of Bitmaps``` button, instead of specifing each files.


Bitmap Kind                  | File Name
-----------------------------|------------------
color map for top face       | pcb-top-base.png
height map for top face      | pcb-top-hmap.png
cut map for top face         | pcb-top-mask.png
color map for bottom face    | pcb-bottom-base.png
height map for bottom face   | pcb-bottom-hmap.png
curt map for bottom face     | pcb-bottom-mask.png

Once all information are filled, press ```OK``` button in order to generate appearances.<br>
Then, execute ```Appearances``` command in ```Modify``` panel, and confirm following four appearances are added in your design.

- top-pcb-base
- bottom-pcb-base
- top-pcb-metal
- bottom-pcb-metal

Change body visibility that ```base``` is visible and ```metal``` is hidden, then apply ```top-pcb-base``` appearance to top face and ```bottom-pcb-base``` appearance to bottom face. 

<p align="center">
    <img alt="step 4-2 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make4-2.jpg" width=700>
</p>

```metal``` body's appearance is also arranged.<br>
Change body visibility that ```base``` is hidden and ```metal``` is visible, then apply ```top-pcb-metal``` appearance to top face and ```bottom-pcb-metal``` appearance to bottom face.

<p align="center">
    <img alt="step 4-3 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make4-3.jpg" width=700>
</p>

### 5. Placing device models on board
Before proceed this last step, confirm that your device model repository is included in current project.

<p align="center">
    <img alt="step 5-1 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make5-1.jpg" width=700>
</p>

Select a component to insert device models. Of cause root component can be specified.<br>
Then, execute ```Place components on PCB``` command in ```Insert``` panel.<br>
As a result of execution, following dialog box is shown.

<p align="center">
    <img alt="step 5-2 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make5-2.jpg" width=300>
</p>

Specify place-info file exported at step 1, your device model library folder path in current project, and board thickness. then press ```OK``` button.<br>
Progress dialog is shown, and it may take a couple of minutes.

<p align="center">
    <img alt="step 5-3 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make5-3.jpg" width=400>
</p>

Finaly, It's complete to make PCB 3D model for rendering.<br>

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/make5-4.jpg" width=700>
</p>

## Example rendered images

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/rcstick-f/images/board01.jpg" width=800>
</p>

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/PCBModelHelper/images/elflet.jpg" width=800>
</p>

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/stm32breakout/images/board.jpg" width=800>
</p>

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/sonopi-dac/images/sonopi-dac-configuration.jpg" width=800>
</p>

<p align="center">
    <img alt="step 5-4 of making model" src="https://raw.githubusercontent.com/wiki/opiopan/Track-Cam/images/trackCAM.jpg" width=800>
</p>
